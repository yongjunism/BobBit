{% extends 'base/base.html' %}
{% load static %}
{% block head %}
<link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">
<link href="{% static 'css/pricePredict/price.css' %}" rel="stylesheet">
<link href="{% static 'css/pricePredict/bootstrap-datepicker.css' %}" rel="stylesheet">
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
{% endblock head %}

{% block contents %}
    <div class ="p_Container">
        <div class = "catagori-Nav">
        {% for pd in pd_list %}
        <li class="page-item">
            {% if pd.pNo ==  product_info.pNo %}
            <a class="select" href='../{{ pd.pNo }}'>
                {{ pd.pName }}
            </a>
            {% else %}
            <a class="non-select" href='../{{ pd.pNo }}'>
                {{ pd.pName }}
            </a>
            {% endif %}
        </li>
        {% endfor %}
        </div>
        <section class = "title_section">
            <h1>{{icon}} {{product_info.pName}}</h1>
            <li> ëŒ€í˜•ë§ˆíŠ¸ "ì›ê°€" ê¸°ì¤€</li>
        </section>
        <div class= "line"></div>
        <div id = "content-area">
            <div id = "content_1">
                <div class = "datearea">
                    <li>ë‚ ì§œë¥¼ ì„ íƒí•´ ì›í•˜ëŠ” ì°¨íŠ¸ë¥¼ ì´ë™í•´ë³´ì„¸ìš”ğŸ‘‰</li>
                    <div class = "datepicker">
                        <input type="text" id="datePicker" value={{today.year}}-{{today.month}}-{{today.day}}>
                    </div>
                </div>
                <section class ="chartarea">
                    <div id="chartdiv"></div>
                </section>
            </div>
            <div id = "content_2">
                <div class="predict">
                    <span class = "pre_div name_section" id = "p_Name">
                        <p>{{product_info.pName}}</p>
                        <div class = "heart_section">
                          {% if isLike %}
                          <div class="wish heart"> </div>
                          {% else %}
                          <div class="wish cleanheart"> </div>
                          {% endif %}
                          <p id="count">
                              {{ wish_count }}
                          </p>
                        </div>
                    </span>
                    <span class = "pre_div">
                        <h1 id ="p_Month">{{lastmonth}}</h1>
                        <p>ì›” ëŒ€ë¹„</p>
                        {% if next_price > now_price %}
                        <div id = "up_Box">
                            <span>
                            <p class = "icon">â–¼&nbsp&nbsp&nbsp</p>
                            <h1>
                                <script>
                                document.write(Math.abs(Math.round({{next_price}}-{{now_price}})));
                                </script>
                            </h1>
                            <p>ì›</p>
                            </span>
                            <span>
                                <p class = "icon">â–²&nbsp&nbsp&nbsp</p>
                                <h1>
                                    <script>
                                    document.write(Math.abs(Math.round(({{next_price}}-{{now_price}}) / {{now_price}} * 100 * 100) /100));
                                    </script>
                                </h1>
                                <p>%</p>
                            </span>
                        </div>
                        {% else %}
                        <div id = "down_Box">
                            <span>
                            <p class = "icon">â–¼&nbsp&nbsp&nbsp</p>
                            <h1>
                                <script>
                                document.write(Math.abs(Math.round({{next_price}}-{{now_price}})));
                                </script>
                            </h1>
                            <p>ì›</p>
                            </span>
                            <span>
                                <p class = "icon">â–¼&nbsp&nbsp&nbsp</p>
                                <h1>
                                    <script>
                                    document.write(Math.abs(Math.round(({{next_price}}-{{now_price}}) / {{now_price}} * 100 * 100) /100));
                                    </script>
                                </h1>
                                <p>%</p>
                            </span>
                        </div>
                        {% endif %}
                        <p>ì˜ˆìƒë©ë‹ˆë‹¤</p>
                    </span >
                    <span class = "pre_div">
                        <form name="form1">
                              <ul id="info">
                                <li>
                                  <div class = "box" id = "now_price">
                                    <label for="price"> í˜„ì¬ ê°€ê²©(1ê°œ)</label>
                                    <div>
                                    <input type="text" name="price" value={{now_price}} style="width:100px; height:30px" readonly>ì›
                                    </div>
                                  </div>
                                </li>
                                <li>
                                    <div class = "box" id = "quantity_box">
                                      <label for="quantity">ìˆ˜ëŸ‰</label>
                                      <div class = "button-box">
                                      <input id = "text" type="text" name="quantity" value="1" max="" style="width:100px; height:30px">
                                      <input id = "button" type="button" value=" + " name="add">
                                      <input id = "button" type="button" value=" - " name="minus">
                                      </div>
                                    </div>
                                </li>
                                <li>
                                  {% if user.is_authenticated %}
                                    <div class = "box" id = "buy_box" data-toggle="modal" data-target="#exampleModalCenter">
                                  {% else %}    
                                    <div class = "box" id = "buy_box">
                                  {% endif %} 
                                        <label for="total">êµ¬ë§¤</label>
                                        <div class = "button-box">
                                        <input id = "text" type="text" name="total" value="{{totalVal}}" style="width:100px; height:30px" readonly>p
                                        </div>
                                    </div>
                                </li>
                              </ul>
                              <!-- Modal -->
                            {% comment %} <div>
                              {% if request.session %}
                                <input type="submit" class="purchase" value="êµ¬ë§¤" onclick="alert('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')">
                              {% else %}
                                <input type="button" class="login" value="êµ¬ë§¤" onclick="windows.open('../../accounts/login')">
                              {% endif %}
                            </div> {% endcomment %}
                          </form>
                    </span>
                </div>
            </div>
        </div>
        <div class= "line"></div>
        <div id="recommend-area">
          <h2> êµ¬ë§¤ì¶”ì²œ</h2>
          <h6 class = "sub-title"> í•´ë‹¹ ê°€ê²©ì€ coupang ë­í‚¹ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.</h6>
          <div class="others" style="padding-left:50px">
              {% for pd in crawlingdata %}
              <div id = "product_row">
                  <p class = "name">{{pd.pName}}</p>
                  {% if pd.pFree == True %}
                  <p class = "free"><u>ë°°ì†¡ë¹„ í¬í•¨</u></p>
                  {% else %}
                  <p class = "notfree"><u>ë°°ì†¡ë¹„ ë¯¸í¬í•¨</u></p>
                  {% endif %}
                  <p class = "price">{{pd.price}}ì›</p>
                  <input class = "button" type="button" value="êµ¬ë§¤í•˜ëŸ¬ ê°€ê¸°" onclick="window.open('{{ pd.plink }}')"><br>
                </div>
              {% endfor %}
          </div>
        </div>
    </div>
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">êµ¬ë§¤</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class = "price-table">
              <colgroup>
                <col width = "50%">
                <col width = "50%">
              </colgroup>
              <tbody>
                <tr>
                  <th>ë³´ìœ  í¬ì¸íŠ¸</th>
                  <td id = "now_p">{{ user.point }}</td>
                </tr>
                <tr class ="deduct">
                  <th>ì°¨ê° í¬ì¸íŠ¸</th>
                  <td id = "deduct_p">{{ now_price }}</td>
                </tr>
                <tr class ="residual">
                  <th>ì”ì—¬ í¬ì¸íŠ¸</th>
                  <td id = "remain_p">0</td>
                </tr>
              </tbody>
            </table>
            êµ¬ë§¤í• ê¹Œìš”?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" id = "buynow" class="btn btn-primary">êµ¬ë§¤í•˜ê¸°</button>
          </div>
        </div>
      </div>
{% endblock contents %}

{% block script_section %}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
{% comment %} <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    let xss_str = "{{pd_data}}";
    xss_str = xss_str.replace(/&quot;/g,'"');
    let price_data = JSON.parse(xss_str)
    let next_price = Math.round({{next_price}})
    let next_date = "{{today.year}}-{{today.month}}-01"
</script>
<script src="{% static 'js/pricePredict/amcharts.js'%}"></script>
<script src="{% static 'js/pricePredict/bootstrap-datepicker.js'%}"></script>
<script>
    const csrftoken = getCookie('csrftoken');
	$(function() {
		$('#datePicker').datepicker({
		    format: "yyyy-mm-dd",	//ë°ì´í„° í¬ë§· í˜•ì‹(yyyy : ë…„ mm : ì›” dd : ì¼ )
		    autoclose : true,	//ì‚¬ìš©ìê°€ ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ìë™ ìº˜ë¦°ë”ê°€ ë‹«íˆëŠ” ì˜µì…˜
		    clearBtn : true, //ë‚ ì§œ ì„ íƒí•œ ê°’ ì´ˆê¸°í™” í•´ì£¼ëŠ” ë²„íŠ¼ ë³´ì—¬ì£¼ëŠ” ì˜µì…˜ ê¸°ë³¸ê°’ false ë³´ì—¬ì£¼ë ¤ë©´ true
		    showWeekDays : true ,// ìœ„ì— ìš”ì¼ ë³´ì—¬ì£¼ëŠ” ì˜µì…˜ ê¸°ë³¸ê°’ : true
		    title: "ë‚ ì§œ ì„ íƒ",	//ìº˜ë¦°ë” ìƒë‹¨ì— ë³´ì—¬ì£¼ëŠ” íƒ€ì´í‹€
		    todayHighlight : true ,	//ì˜¤ëŠ˜ ë‚ ì§œì— í•˜ì´ë¼ì´íŒ… ê¸°ëŠ¥ ê¸°ë³¸ê°’ :false 
		    language : "ko"	//ë‹¬ë ¥ì˜ ì–¸ì–´ ì„ íƒ, ê·¸ì— ë§ëŠ” jsë¡œ êµì²´í•´ì¤˜ì•¼í•œë‹¤.
		}).on("changeDate", function(e){

        })
	})
</script>
<script type="text/javascript">
  const now_point = document.getElementById("now_p");
  const deduct_price = document.getElementById("deduct_p");
  const remain_price = document.getElementById("remain_p");
  const formform = document.getElementsByName("form1"),
        price = document.form1.price,
        quantity = document.form1.quantity,
        add = document.form1.add,
        minus = document.form1.minus,
        total = document.form1.total;

  let quantityVal;
  let totalVal;
  let priceVal;
  remain_price.innerHTML = now_point.innerHTML - deduct_price.innerHTML;

  if(remain_price.innerHTML < 0){
    remain_price.style.color = 'red';
  }

  if (formform){
    total.value = price.value;

    quantityVal = quantity.value;
    totalVal = total.value;
    priceVal = price.value;

    if(add){
      add.addEventListener('click', function(){
        quantityVal++;
        totalVal = quantityVal * priceVal;
        quantity.value = quantityVal;
        total.value = totalVal;
        deduct_price.innerHTML  = totalVal;
        remain_price.innerHTML = now_point.innerHTML - totalVal;
        if(remain_price.innerHTML < 0){
          remain_price.style.color = 'red';
        }else{
          remain_price.style.color = 'black';
        }
      })
    }
      
    if(minus){
      minus.addEventListener('click', function(){
        if (quantityVal > 1){
          quantityVal--;
          totalVal = quantityVal * priceVal;
          quantity.value = quantityVal;
          total.value = totalVal;
          deduct_price.innerHTML  = totalVal;
          remain_price.innerHTML = now_point.innerHTML - totalVal;
          if(remain_price.innerHTML < 0){
            remain_price.style.color = 'red';
          }else{
            remain_price.style.color = 'black';
          }
      }else{
        quantityVal = 1;
        }
      })
    }
  }
</script>
{% comment %} ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ì°œí•˜ê¸°ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ {% endcomment %}
<script type="text/javascript">
  $(".wish").click(function () { // .like ë²„íŠ¼ì„ í´ë¦­ ê°ì§€
    {% if user.is_authenticated %}
      $.ajax({ // ajaxë¡œ ì„œë²„ì™€ í†µì‹ 
          type: "POST", // ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•
          url: "./wish/", // í†µì‹ í•  urlì„ ì§€ì •
          data: {'csrfmiddlewaretoken': '{{ csrf_token }}' }, // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ì‹œ ì˜µì…˜, pkë¥¼ ë„˜ê²¨ì•¼ ì–´ë–¤ videoì¸ì§€ ì•Œ ìˆ˜ ìˆìŒ
          dataType: "json",
          success: function (response) { // ì„±ê³µ
              alert(response.message);
              $("#count").html(response.wish_count); // ì¢‹ì•„ìš” ê°œìˆ˜ ë³€ê²½
              if(response.message == "ì¢‹ì•„ìš”"){
                $(".wish").attr('class', 'wish heart')
              }else{
                $(".wish").attr('class', 'wish cleanheart')
              }
          },
          error: function (request, status, error) { // ì‹¤íŒ¨
          },   
      });
      {% else %}
      window.location.replace("/accounts/login/") // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ê¸°
      {% endif %}
  })
</script>
{% comment %} ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡êµ¬ë§¤í•˜ê¸°ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ã…¡ {% endcomment %}

<script type="text/javascript">

  $("#buy_box").click(function () { // .like ë²„íŠ¼ì„ í´ë¦­ ê°ì§€
    {% if not user.is_authenticated %}
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.")
      window.location.replace("/accounts/login/") // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ê¸°
    {% endif %}
  });

  //êµ¬ë§¤ë²„íŠ¼ ëˆŒë €ì„ë•Œ
  $("#buynow").click(function () { // .like ë²„íŠ¼ì„ í´ë¦­ ê°ì§€
    {% if user.is_authenticated %}

    if(remain_price.innerHTML < 0){
      alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.')
    }else{
      $.ajax({ // ajaxë¡œ ì„œë²„ì™€ í†µì‹ 
        type: "POST", // ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²•
        url: "./buy/", // í†µì‹ í•  urlì„ ì§€ì •
        data: {'quantityVal' : quantityVal,
        'priceVal' : priceVal,
        'csrfmiddlewaretoken': '{{ csrf_token }}' }, 
        dataType: "json",
        success: function (response) { // ì„±ê³µ
            if(response.content){
              alert('êµ¬ë§¤ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')
              window.location.replace("./")
            }
        },
        error: function (request, status, error) { // ì‹¤íŒ¨
        },   
      })
    }
    {% else  %}
      alert("ë¹„ì •ìƒì ì¸ ì ‘ê·¼ì…ë‹ˆë‹¤.")
    {% endif %}
});
</script>
{% endblock script_section %}